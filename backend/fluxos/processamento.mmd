flowchart TD
    %% Cores e Estilos BÃ¡sicos
    classDef whatsapp fill:#25D366,stroke:#fff,stroke-width:2px,color:#fff;
    classDef aws fill:#FF9900,stroke:#232F3E,stroke-width:2px;
    classDef db fill:#3ECF8E,stroke:#fff,stroke-width:2px,color:#fff;
    classDef ai fill:#74AA9C,stroke:#fff,stroke-width:2px,color:#fff;
    classDef node fill:#339933,stroke:#fff,stroke-width:2px,color:#fff;

    %% Atores e Componentes
    USER((ğŸ‘¤ UsuÃ¡rio))

    subgraph Canal [Canal de Entrada]
        WAPP[ğŸ’¬ Grupo do WhatsApp]:::whatsapp
        EVO[ğŸ”Œ Evolution API]:::node
    end

    subgraph Backend Ingestao [IngestÃ£o e Armazenamento Otimizado]
        API["âš¡ Backend / Webhook Handler<br/>Node.js + TS"]:::node
        DB[("ğŸ—„ï¸ Supabase<br/>PostgreSQL")]:::db
    end

    subgraph Inteligencia [Pipeline AssÃ­ncrono de IA]
        WORKER["âš™ï¸ Worker / Job Processor<br/>Node.js"]:::node
        GPT["ğŸ§  ChatGPT API<br/>gpt-4o-mini / JSON Mode"]:::ai
    end

    subgraph Consumo [ExibiÃ§Ã£o]
        FRONT[ğŸ“Š Frontend / Dashboard]
    end

    %% RelaÃ§Ãµes
    USER -->|Digita Mensagem| WAPP
    WAPP -->|Ouve evento| EVO
    EVO -->|Dispara HTTP POST| API

    API -->|"1. Cria UsuÃ¡rio (se novo)<br/>2. Salva Mensagem Status: PENDING"| DB
    API -.->|"Responde 200 OK rÃ¡pido<br/>(Evita timeout do Zap)"| EVO

    DB -.->|Fila de Mensagens Pendentes| WORKER
    WORKER -->|Envia Texto + Prompt + Contexto| GPT
    GPT -->|Retorna JSON: EmoÃ§Ã£o, IntenÃ§Ãµes, Delta Skills| WORKER

    WORKER -->|"Atualiza status para PROCESSED<br/>Soma o Delta no Perfil"| DB

    FRONT -->|Consulta API REST| DB

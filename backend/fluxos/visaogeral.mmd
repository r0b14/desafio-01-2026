---
id: 6342e4f9-97dd-492e-a2c4-b158d61f5769
---
sequenceDiagram
    autonumber

    box rgba(37, 211, 102, 0.1) "Canal de Comunica√ß√£o"
        actor U as Usu√°rio
        participant EVO as Evolution API
    end

    box rgba(51, 153, 51, 0.1) "Ingest√£o R√°pida (S√≠ncrona)"
        participant API as Webhook API
        participant DB as Supabase (PostgreSQL)
    end

    box rgba(62, 207, 142, 0.1) "Intelig√™ncia (Ass√≠ncrona)"
        participant Worker as IA Worker
        participant GPT as API OpenAI
    end

    Note over U, GPT: üöÄ FASE 1: Ingest√£o de Alta Velocidade (Imediato)

    U->>EVO: Envia: "Voc√™s viram a nova feature? Resolvi!"
    activate EVO

    EVO->>API: HTTP POST /webhooks/evolution
    activate API

    API->>DB: Consulta/Cria Usu√°rio (whatsapp_id)
    API->>DB: Insere `messages` (RAW) c/ status = 'PENDING'

    API-->>EVO: HTTP 200 OK (Imediato, evita retry do zap)
    deactivate API
    deactivate EVO

    Note over DB, GPT: üß† FASE 2: Processamento e Intelig√™ncia (Desacoplado)

    loop Execu√ß√£o Ass√≠ncrona
        Worker->>DB: SELECT messages WHERE status = 'PENDING'
        activate Worker
        DB-->>Worker: Retorna batch de mensagens

        Worker->>GPT: Chamada API (Structured Outputs / JSON Mode)
        activate GPT
        Note right of GPT: O Prompt for√ßa retorno JSON:<br/>Emo√ß√£o: Engajamento<br/>Inten√ß√£o: Resolu√ß√£o<br/>Skill Delta: Proatividade +0.2

        GPT-->>Worker: Retorna extra√ß√£o tipada (JSON exato)
        deactivate GPT
    end

    Note over DB, Worker: üíæ FASE 3: Persist√™ncia do Perfil Din√¢mico

    Worker->>DB: Insere registro em `emotions`
    Worker->>DB: Insere registros em `intentions`
    Worker->>DB: UPDATE `user_skills` (Soma o +0.2 no perfil)
    Worker->>DB: UPDATE `messages` status = 'PROCESSED'
    deactivate Worker

